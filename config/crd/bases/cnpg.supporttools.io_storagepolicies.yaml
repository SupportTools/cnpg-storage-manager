---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: storagepolicies.cnpg.supporttools.io
spec:
  group: cnpg.supporttools.io
  names:
    kind: StoragePolicy
    listKind: StoragePolicyList
    plural: storagepolicies
    shortNames:
    - sp
    singular: storagepolicy
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.managedClusters
      name: Managed
      type: integer
    - jsonPath: .spec.thresholds.warning
      name: Warning
      type: integer
    - jsonPath: .spec.thresholds.critical
      name: Critical
      type: integer
    - jsonPath: .spec.thresholds.expansion
      name: Expansion
      type: integer
    - jsonPath: .spec.dryRun
      name: DryRun
      type: boolean
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: StoragePolicy is the Schema for the storagepolicies API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: StoragePolicySpec defines the desired state of StoragePolicy
            properties:
              alerting:
                description: Alerting defines alerting settings
                properties:
                  channels:
                    description: Channels is the list of alert channels
                    items:
                      description: AlertChannel defines a single alert channel configuration
                      properties:
                        channel:
                          description: Channel for slack notifications
                          type: string
                        endpoint:
                          description: Endpoint for alertmanager type
                          type: string
                        routingKeySecret:
                          description: RoutingKeySecret is the name of the secret
                            containing routing key for pagerduty
                          type: string
                        type:
                          description: Type of alert channel
                          enum:
                          - alertmanager
                          - slack
                          - pagerduty
                          type: string
                        webhookSecret:
                          description: WebhookSecret is the name of the secret containing
                            webhook URL for slack
                          type: string
                      required:
                      - type
                      type: object
                    type: array
                  escalationMinutes:
                    default: 15
                    description: EscalationMinutes is the time before re-alerting
                      on unresolved issues
                    format: int32
                    minimum: 1
                    type: integer
                  suppressDuringRemediation:
                    default: true
                    description: SuppressDuringRemediation suppresses alerts while
                      remediation is active
                    type: boolean
                type: object
              backupMonitoring:
                description: BackupMonitoring defines backup and WAL archiving monitoring
                  settings
                properties:
                  alertOnNoBackupConfigured:
                    default: true
                    description: AlertOnNoBackupConfigured alerts if a cluster has
                      no backup configured
                    type: boolean
                  enabled:
                    default: true
                    description: Enabled determines if backup monitoring is enabled
                    type: boolean
                  maxBackupAgeHours:
                    default: 24
                    description: |-
                      MaxBackupAgeHours is the maximum age of the last successful backup before alerting
                      Set to 0 to disable backup age monitoring
                    format: int32
                    minimum: 0
                    type: integer
                  maxRecoveryPointAgeHours:
                    default: 168
                    description: |-
                      MaxRecoveryPointAgeHours is the maximum age of the first recovery point before alerting
                      Set to 0 to disable recovery point age monitoring
                    format: int32
                    minimum: 0
                    type: integer
                  requireContinuousArchiving:
                    default: true
                    description: RequireContinuousArchiving alerts if WAL archiving
                      is not working
                    type: boolean
                type: object
              circuitBreaker:
                description: CircuitBreaker defines circuit breaker settings
                properties:
                  maxFailures:
                    default: 3
                    description: MaxFailures is the number of failures before circuit
                      opens
                    format: int32
                    minimum: 1
                    type: integer
                  resetMinutes:
                    default: 60
                    description: ResetMinutes is the time before circuit resets
                    format: int32
                    minimum: 1
                    type: integer
                  scope:
                    default: per-cluster
                    description: Scope defines whether circuit breaker is per-cluster
                      or global
                    enum:
                    - per-cluster
                    - global
                    type: string
                type: object
              dryRun:
                default: false
                description: DryRun enables dry-run mode where no actions are taken
                type: boolean
              excludeClusters:
                description: ExcludeClusters is a list of clusters to exclude even
                  if they match the selector
                items:
                  description: ClusterReference identifies a specific CNPG cluster
                  properties:
                    name:
                      description: Name of the CNPG cluster
                      type: string
                    namespace:
                      description: Namespace of the CNPG cluster
                      type: string
                  required:
                  - name
                  - namespace
                  type: object
                type: array
              expansion:
                description: Expansion defines PVC expansion settings
                properties:
                  cooldownMinutes:
                    default: 30
                    description: CooldownMinutes is the minimum time between expansions
                    format: int32
                    minimum: 0
                    type: integer
                  enabled:
                    default: true
                    description: Enabled determines if automatic PVC expansion is
                      enabled
                    type: boolean
                  maxSize:
                    anyOf:
                    - type: integer
                    - type: string
                    description: MaxSize is the maximum PVC size limit
                    pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                    x-kubernetes-int-or-string: true
                  minIncrementGi:
                    default: 5
                    description: MinIncrementGi is the minimum expansion size in Gi
                    format: int32
                    minimum: 1
                    type: integer
                  percentage:
                    default: 50
                    description: Percentage to expand PVC by when threshold is breached
                    format: int32
                    maximum: 500
                    minimum: 1
                    type: integer
                type: object
              selector:
                description: Selector is a label selector for matching CNPG clusters
                properties:
                  matchExpressions:
                    description: matchExpressions is a list of label selector requirements.
                      The requirements are ANDed.
                    items:
                      description: |-
                        A label selector requirement is a selector that contains values, a key, and an operator that
                        relates the key and values.
                      properties:
                        key:
                          description: key is the label key that the selector applies
                            to.
                          type: string
                        operator:
                          description: |-
                            operator represents a key's relationship to a set of values.
                            Valid operators are In, NotIn, Exists and DoesNotExist.
                          type: string
                        values:
                          description: |-
                            values is an array of string values. If the operator is In or NotIn,
                            the values array must be non-empty. If the operator is Exists or DoesNotExist,
                            the values array must be empty. This array is replaced during a strategic
                            merge patch.
                          items:
                            type: string
                          type: array
                          x-kubernetes-list-type: atomic
                      required:
                      - key
                      - operator
                      type: object
                    type: array
                    x-kubernetes-list-type: atomic
                  matchLabels:
                    additionalProperties:
                      type: string
                    description: |-
                      matchLabels is a map of {key,value} pairs. A single {key,value} in the matchLabels
                      map is equivalent to an element of matchExpressions, whose key field is "key", the
                      operator is "In", and the values array contains only "value". The requirements are ANDed.
                    type: object
                type: object
                x-kubernetes-map-type: atomic
              thresholds:
                description: Thresholds defines storage usage thresholds
                properties:
                  critical:
                    default: 80
                    description: Critical threshold percentage for generating critical
                      alerts
                    format: int32
                    maximum: 100
                    minimum: 0
                    type: integer
                  emergency:
                    default: 90
                    description: Emergency threshold percentage for triggering WAL
                      cleanup
                    format: int32
                    maximum: 100
                    minimum: 0
                    type: integer
                  expansion:
                    default: 85
                    description: Expansion threshold percentage for triggering automatic
                      PVC expansion
                    format: int32
                    maximum: 100
                    minimum: 0
                    type: integer
                  warning:
                    default: 70
                    description: Warning threshold percentage for generating warning
                      alerts
                    format: int32
                    maximum: 100
                    minimum: 0
                    type: integer
                type: object
              walCleanup:
                description: WALCleanup defines WAL file cleanup settings
                properties:
                  cooldownMinutes:
                    default: 15
                    description: CooldownMinutes is the minimum time between WAL cleanups
                    format: int32
                    minimum: 0
                    type: integer
                  enabled:
                    default: true
                    description: Enabled determines if WAL cleanup is enabled
                    type: boolean
                  requireArchived:
                    default: true
                    description: RequireArchived ensures only archived WAL files are
                      cleaned
                    type: boolean
                  retainCount:
                    default: 10
                    description: RetainCount is the minimum number of WAL files to
                      retain
                    format: int32
                    minimum: 1
                    type: integer
                type: object
            type: object
          status:
            description: StoragePolicyStatus defines the observed state of StoragePolicy
            properties:
              conditions:
                description: Conditions represent the current state of the StoragePolicy
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              lastEvaluated:
                description: LastEvaluated is the timestamp of the last policy evaluation
                format: date-time
                type: string
              managedClusters:
                description: ManagedClusters is the list of clusters managed by this
                  policy
                items:
                  description: ManagedCluster represents a cluster managed by this
                    policy
                  properties:
                    backupStatus:
                      description: BackupStatus contains backup-related status information
                      properties:
                        backupConfigured:
                          description: BackupConfigured indicates if backups are configured
                            for the cluster
                          type: boolean
                        backupHealthStatus:
                          description: BackupStatus is the overall backup health status
                          type: string
                        continuousArchivingWorking:
                          description: ContinuousArchivingWorking indicates if WAL
                            archiving is functioning
                          type: boolean
                        firstRecoverabilityPoint:
                          description: FirstRecoverabilityPoint is the timestamp of
                            the oldest recoverable point
                          format: date-time
                          type: string
                        lastBackupAgeHours:
                          description: LastBackupAgeHours is how many hours since
                            the last backup
                          format: int32
                          type: integer
                        lastBackupTime:
                          description: LastBackupTime is the timestamp of the last
                            successful backup
                          format: date-time
                          type: string
                      type: object
                    lastChecked:
                      description: LastChecked is when the cluster was last evaluated
                      format: date-time
                      type: string
                    name:
                      description: Name of the CNPG cluster
                      type: string
                    namespace:
                      description: Namespace of the CNPG cluster
                      type: string
                    status:
                      description: Status is the current status of the cluster
                      type: string
                    usagePercent:
                      description: UsagePercent is the current storage usage percentage
                      format: int32
                      type: integer
                  required:
                  - lastChecked
                  - name
                  - namespace
                  - status
                  - usagePercent
                  type: object
                type: array
              observedGeneration:
                description: ObservedGeneration is the generation observed by the
                  controller
                format: int64
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
